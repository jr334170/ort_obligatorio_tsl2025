---

- name: Hardening de servidores Ubuntu
  hosts: ubuntu
  become: true
  collections:
    - community.general

  tasks:
    - name: TAREA#1 Actualizamos paquetes
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes
      notify: Reiniciar sistema si hay actualizaciones

    - name: TAREA#2 Instalamos paquetes (ufw y fail2ban)
      ansible.builtin.apt:
        name: [ufw, fail2ban]
        state: present

    - name: TAREA#3 Política entrante DENY
      community.general.ufw:
        default: deny
        direction: incoming
      notify: Recargar UFW

    - name: TAREA#4 Política saliente ALLOW
      community.general.ufw:
        default: allow
        direction: outgoing
      notify: Recargar UFW

    - name: TAREA#5 Permitimos OpenSSH
      community.general.ufw:
        rule: allow
        name: OpenSSH
      notify: Recargar UFW

    - name: TAREA#6 Habilitamos UFW (y arranque automático)
      community.general.ufw:
        state: enabled

    - name: TAREA#7 SSH solo con clave pública
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
      notify: Reiniciar ssh

    - name: TAREA#8 part1 Prohibimos login de root por SSH y eliminamos cloud-init drop-in
      block:
       - name: TAREA#8 part2  Eliminar drop-in 50-cloud-init.conf si existe
         ansible.builtin.file:
           path: /etc/ssh/sshd_config.d/50-cloud-init.conf
           state: absent

       - name: TAREA#8 part3 Deshabilitar login de root por SSH en sshd_config
         ansible.builtin.lineinfile:
           path: /etc/ssh/sshd_config
           regexp: '^\s*#?\s*PermitRootLogin'
           line: 'PermitRootLogin no'
      notify: Reiniciar ssh

    - name: TAREA#9 Jail SSH en fail2ban
      ansible.builtin.blockinfile:
        path: /etc/fail2ban/jail.d/sshd.local
        create: true
        block: |
          [sshd]
          enabled = true
          maxretry = 5
          findtime = 10m
          bantime = 1h
      notify: Reiniciar fail2ban

    - name: TAREA#10 Aseguramos fail2ban iniciado y habilitado
      ansible.builtin.service:
        name: fail2ban
        state: started
        enabled: true

  handlers:
    - name: Recargar UFW
      community.general.ufw:
        state: reloaded

    - name: Reiniciar sistema si hay actualizaciones
      ansible.builtin.reboot:
        msg: "Reinicio tras actualización de paquetes"
        connect_timeout: 5
        reboot_timeout: 600

    - name: Reiniciar ssh
      ansible.builtin.service:
        name: ssh
        state: restarted

    - name: Reiniciar fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted
